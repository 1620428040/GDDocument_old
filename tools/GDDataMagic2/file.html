<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>基本的列表页面</title>
		<script src="js/jquery-1.9.1.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/DataMagic-base.js" type="text/javascript" charset="utf-8"></script>
		
		<!--引用bootstrap框架中的文件和适配bootstrap的view部分-->
		<link rel="stylesheet" type="text/css" href="view/bootstrap/bootstrap/css/bootstrap.min.css"/>
		<script src="view/bootstrap/bootstrap/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="view/bootstrap/bootstrap/bootstrap-datetimepicker.min.css"/>
		<script src="view/bootstrap/bootstrap/bootstrap-datetimepicker.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="view/bootstrap/DataMagic.bootstrap.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="view/bootstrap/DataMagic.bootstrap.css"/>
		
		<!--适配echarts-->
		<style type="text/css">
	    	.echarts-box{
	    		float:left;
	    		width: 600px;
	    		height:400px;
	    	}
	    	.charts-back {
				cursor: pointer;
				margin: 5px;
				padding: 5px;
				border: solid 1px lightgray;
				border-radius: 5px;
			}
	    </style>
	    <script src="../statistics/echarts/echarts.min.js"></script>
	    <script type="text/javascript">
	    	function TypeStatistics(title,dom,style){
	    		this.option=$.extend(true,{},this.defaultOption);
	    		this.option.title.text=title;
	    		this.dataList=[];
	    		this.echarts=echarts.init(dom);
	    	}
	    	TypeStatistics.prototype.defaultOption={
			    title: {},
			    tooltip : {
			        trigger: 'item',
			        formatter: "{a} <br/>{b} : {c} ({d}%)"
			    },
			    legend: {
	                data:[]
	           	},
			    series : []
			};
	        TypeStatistics.prototype.defaultSeries={
	            center: ['50%', '50%'],
	            label: {
	                normal: {}
	            },
	            labelLine: {
	                normal: {}
	            },
	            itemStyle: {
	                normal: {}
	            },
	            animationType: 'scale',
	            animationEasing: 'elasticOut',
	            animationDelay: function (idx) {
	                return Math.random() * 200;
	            }
	       	}
	    	TypeStatistics.prototype.addSeries=function(name,type,data,titles){
	    		var newData=[];
		    	for(var kn in data){
		    		var title=titles[kn]||kn;
		    		newData.push({name:title,value:data[kn]});
		    	}
	    		
	    		this.dataList.push(newData);
	    		var series=$.extend(true,{},this.defaultSeries);
	    		series.name=name;
	    		series.type=type;
	    		series.data=newData.sort(function (a, b){
	    			return a.value - b.value
	    		});
	    		this.option.legend.data.push(name);
	    		this.option.series.push(series);
		        return this;
	    	}
	    	TypeStatistics.prototype.refresh=function(){
	    		var series=this.option.series;
	    		if(series.length===1){
	    			series[0].radius="50%";
	    		}
	    		else if(series.length===2){
	    			series[0].radius=[0, '30%'];
	    			series[0].label.normal.position='inner';
	    			
	    			series[1].radius=['40%', '60%'];
	    		}
	    		else if(series.length===3){
	    			series[0].radius=[0, '25%'];
	    			series[0].label.normal.position='inner';
	    			
	    			series[1].radius=['30%', '50%'];
	    			series[1].label.normal.position='inner';
	    			
	    			series[2].radius=['55%', '70%'];
	    		}
	        	this.echarts.setOption(this.option);
		        return this;
	    	}
	    	
	    	function TimeStatistics(title,yName,dom,style){
	    		this.option=$.extend(true,{},this.defaultOption);
	    		this.option.title.text=title;
	    		this.option.yAxis.name=yName;
	    		this.dataList=[];
	    		this.echarts=echarts.init(dom);
	    		this.container=$(dom);
	    		this.container.append('<div id="charts-back-box" style="position: absolute;top: 20px;right: 20px;">'+
					'<label class="charts-back" id="total">全部</label>'+
					'<label class="charts-back" id="year" style="display: none;">2016年</label>'+
					'<label class="charts-back" id="month" style="display: none;">4月</label>'+
				'</div>');
	    		
	    		this.current={year:null,month:null};
	    		var self=this;
	    		this.echarts.on('click',function(params) {
		        	var num=parseInt(params.name);
		        	if(self.current.year){
		        		if(self.current.month){
		        			
		        		}
		        		else{
		        			self.current.month=num;
		        			self.refresh(self.current.year,self.current.month);
		        			self.container.find("#month").text(self.current.month+"月").show();
		        		}
		        	}
		        	else{
		        		self.current.year=num;
		        		self.refresh(self.current.year);
		        		self.container.find("#year").text(self.current.year+"年").show();
		        	}
		        	return false;
		        });
		        this.container.find("#total").click(function(){
		        	self.back("total");
		        });
		        this.container.find("#year").click(function(){
		        	self.back("year");
		        });
	    	}
	    	TimeStatistics.prototype.defaultOption={
	            title: {},
	            tooltip: {},
	            legend: {
	                data:[]
	            },
	            xAxis: {
	            	name:"x轴",
	            	data:null
	            },
	            yAxis: {
	            	name:"y轴"
	            },
	            series: []
	        };
	        TimeStatistics.prototype.defaultSeries={
	            name: '修改',
	            type: 'bar',
	            data:null
	        }
	    	TimeStatistics.prototype.addSeries=function(name,type,data){
	    		this.dataList.push(data);
	    		var series=$.extend(true,{},this.defaultSeries);
	    		series.name=name;
	    		series.type=type;
	    		this.option.legend.data.push(name);
	    		this.option.series.push(series);
	    		return this;
	    	}
	    	TimeStatistics.prototype.refresh=function(year,month){
	    		for(var index in this.dataList){
	    			var data=this.dataList[index];
	    			var newData={"title":[],"value":[]};
		    		if(year){
		    			if(month){
		    				for(var i in data[year].details[month].details) {
			    				newData.title.push(i+"日");
			    				newData.value.push(data[year].details[month].details[i]);
			    			}
			    			data.currentMouthData=newData;
			    			this.option.xAxis.name="日期";
		    			}
		    			else{
		    				for(var i in data[year].details) {
			    				newData.title.push(i+"月");
			    				newData.value.push(data[year].details[i].total);
			    			}
			    			data.currentYearData=newData;
			    			this.option.xAxis.name="月份";
		    			}
		    		}
		    		else{
		    			for(var i in data) {
		    				newData.title.push(i+"年");
		    				newData.value.push(data[i].total);
		    			}
		    			data.currentTotalData=newData;
			    		this.option.xAxis.name="年份";
		    		}
		    		this.option.xAxis.data=newData.title;
		    		this.option.series[index].data=newData.value;
	    		}
	        	this.echarts.setOption(this.option);
	        	return this;
	    	}
	    	TimeStatistics.prototype.back=function(layer){
	    		var layerData="currentYearData";
			    this.option.xAxis.name="月份";
	    		if(layer==="total"){
	    			this.current.year=null;
	    			this.container.find("#year").hide();
	    			layerData="currentTotalData";
	    			this.option.xAxis.name="年份";
	    		}
	        	this.current.month=null;
	        	this.container.find("#month").hide();
	        	
	        	for(var index in this.dataList){
					var data=this.dataList[index];
					this.option.xAxis.data=data[layerData].title;
	        		this.option.series[index].data=data[layerData].value;
				}
		        this.echarts.setOption(this.option);
		        return this;
	        }
	    </script>
	    
		<style type="text/css">
			.tab-pane{
				padding: 5px;
			}
			.loading{  
			    width:160px;  
			    height:56px;  
			    position: absolute;  
			    top:50%;
			    left:50%;
			    line-height:56px;
			    color:#fff;
			    padding-left:60px;
			    font-size:15px;
			    background: #000 url(images/loader.gif) no-repeat 10px 50%;
			    opacity: 0.7;
			    z-index:9999;
			    -moz-border-radius:20px;
			    -webkit-border-radius:20px;
			    border-radius:20px;
			    filter:progid:DXImageTransform.Microsoft.Alpha(opacity=70);
			}
		</style>
		<script type="text/javascript">
			//request：将当前URL中包含的参数转化为request对象，用来在前台页面之间传递参数
			var request={};
			var params=location.href.split("?");
			if(params.length>1){
				var params=params[1].split("&");
				for (var i=0;i<params.length;i++) {
					var para=params[i].split("=");
					request[para[0]]=para[1];
				}
			}
			
			var needUpdateStatistics=true;
			function gotoTabPage(gotoTab){
				var currentTab=$(".tab-content .tab-pane.active").attr("id");
				if(currentTab==="listTab"&&gotoTab!=="listTab"&&needUpdateStatistics){
					var tab=$("#"+gotoTab);
					tab.find(".echarts-box").hide();
					var loading=$("#loading-box");
					tab.append(loading);
					loading.show();
					updateStatistics();
				}
				$('[href="#'+gotoTab+'"]').tab('show');
			}
			function updateStatistics(){
				controller.model.statistics([["Type","handle"],["Type","conversion"],["Date","filetime"],["Type","extension"]],function(data){
					$("#loading-box").hide();
					$(".echarts-box").show();
			    	new TypeStatistics("文件处理情况分析",document.getElementById('handle-echarts')).addSeries('处理','pie',data[0],{"other":"其他"}).refresh();
			    	new TypeStatistics("文件转化情况分析",document.getElementById('conversion-echarts')).addSeries('转化','pie',data[1],{"other":"其他"}).refresh();
					new TimeStatistics("文件日期统计","数量",document.getElementById("filetime-echarts")).addSeries('日期编码','bar',data[2]).refresh();
					new TypeStatistics("文件类型统计",document.getElementById('extension-echarts')).addSeries('类型','pie',data[3],{"other":"其他"}).refresh();
			    	needUpdateStatistics=false;
				});
			}
			function downloadZip(){
				DataMagic.Model.request("../../index.php?checknum="+request.checknum+"&message=download",{"where":controller.model.lastFilter},function(data){
					if(data&&typeof data==="string"){
						location.href="../download.php?path="+encodeURIComponent(data);
					}
					else{
						alert("批量下载失败");
					}
				});
			}
			$(function(){
				if(request.tab){
					gotoTabPage(request.tab+'Tab');
				}
				$('.nav-tabs a').click(function (e) {
					e.preventDefault();
					var goto=this.href.split("#")[1];
					gotoTabPage(goto);
				});
				$(document).keydown(function(event){
					if(event.which===13){//回车键  开始搜索
						controller.save();
					}
				});
			});
			var filter={};
			if(request.path){
				request.path=decodeURIComponent(request.path);
				filter.parentpath=request.path;
			}
			var controller=new DataMagic.Controller("uploadfile",sessionStorage,"php/DataMagic2.php",{filter:filter});
			controller.onReady=function(){
				controller.search();
			}
			controller.save=function(){
				DataMagic.Controller.prototype.save.apply(this,arguments);
				$('[href="#listTab"]').tab('show');
				needUpdateStatistics=true;
			}
			controller.refresh=function(){
				DataMagic.Controller.prototype.refresh.apply(this,arguments);
				this.form.container.find(".DMInput").val("");
				needUpdateStatistics=true;
			}
			controller.showForm=function(){
				DataMagic.Controller.prototype.showForm.apply(this,arguments);
				$(".form-group").click(function(){
					$(this).find("input").eq(0).focus();
				})
				$(".form-group input").eq(0).focus();
			}
			controller.model.initWithMeta=function(meta){
				if(request.path){
					delete meta.fieldList.parentpath;
				}
				DataMagic.Model.prototype.initWithMeta.call(this,meta);
			}
			controller.list.hide=function(){};
			controller.list.openItem=function(){};
			controller.form.hide=function(){};
			controller.toolbar.refresh=function(){
				DataMagic.View.Toolbar.prototype.refresh.call(this,["save","refresh"]);
			};
		</script>
	</head>
	<body>
		<div class="col-md-3" id="left">
			<div class="panel panel-primary">
			    <div class="panel-heading">
			        <h3 class="panel-title">搜索条件</h3>
			    </div>
			    <div class="panel-body">
					<form role="form" class="form DMForm"></form>
			    </div>
			    <div class="panel-footer">
			    	<div class="btn-group DMToolbar">
						<a class="btn btn-default DMButton" data-command="save"><span>查找</span></a>
						<a class="btn btn-default DMButton" data-command="refresh"><span>重置</span></a>
					</div>
			    </div>
			</div>
		</div>
		<div class="col-md-9" id="right">
			<div class="panel panel-primary">
				<ul class="nav nav-tabs">
					<li><a href="#listTab">文件列表</a></li>
					<li><a href="#handleTab">办理情况</a></li>
					<li><a href="#conversionTab">转化情况</a></li>
					<li><a href="#statisticsTab">文稿统计</a></li>
				</ul>
				<div class="tab-content">
					<div class="tab-pane fade in active" id="listTab">
						<table class="DMList table table-striped">
							<tr>
								<th>文件名</th>
								<th>创建人</th>
								<th>文件时间</th>
								<th>交办</th>
								<th>办理</th>
								<th>审修</th>
								<th>呈报</th>
								<th>批示</th>
								<th>转化</th>
							</tr>
							<tr class="DMItem">
								<td data-field="title"></td>
								<td data-field="people"></td>
								<td data-field="date"></td>
								<td data-field="assign"></td>
								<td data-field="handle"></td>
								<td data-field="repair"></td>
								<td data-field="report"></td>
								<td data-field="instructions"></td>
								<td data-field="conversion"></td>
							</tr>
						</table>
						<div>
							<div class="btn-group" style="margin: 10px;float: left;">
								<a class="btn btn-default" onclick="downloadZip();"><span >批量下载</span></a>
							</div>
							<ul class="pager" style="padding-top: 10px;">
								<li><a onclick="controller.pageTurn(-1);">上一页</a></li>
								<li><a onclick="controller.pageTurn(1);">下一页</a></li>
							</ul>
							<div style="clear: both;"></div>
						</div>
					</div>
					<div class="tab-pane fade" id="handleTab">
						<div id="handle-echarts" class="echarts-box"></div>
						<div style="clear: both;"></div>
					</div>
					<div class="tab-pane fade" id="conversionTab">
						<div id="conversion-echarts" class="echarts-box"></div>
						<div style="clear: both;"></div>
					</div>
					<div class="tab-pane fade" id="statisticsTab">
						<div id="filetime-echarts" class="echarts-box"></div>
						<div id="extension-echarts" class="echarts-box"></div>
						<div style="clear: both;"></div>
					</div>
				</div>
			</div>
		</div>
		<div id="loading-box" style="height: 500px;display: none;">
			<div class="loading">正在统计...</div>
		</div>
	</body>
</html>
